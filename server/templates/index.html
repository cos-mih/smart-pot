<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Pot Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 20px;
            background-color: #fafff6;
            color: rgb(14, 104, 4);
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            align-items: flex-start;
            padding: 10px;
        }
        .metric-container {
            background-color: #afe9b3;
            border: 3px solid #ff8000;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            color: rgb(14, 104, 4);
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            width: 320px;
            min-height: 300px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }
        .metric-container h2 {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .current-value {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        #temp-chart-container{
            width: 100%;
            height: 150px;
            margin-top: auto;
        }
        #humidity-gauge-container, #light-meter-container {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #temp-chart {
            max-width: 100%;
            height: 150px !important;
        }
        #humidity-gauge {
             width: 150px !important;
             height: 150px !important;
        }
        .light-meter {
            width: 80%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .light-level {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #FFFACD, #FFD700, #FFA500, #FF8C00);
            border-radius: 15px 0 0 15px;
            transition: width 0.5s ease-in-out;
        }
        .status {
            color: rgb(14, 104, 4, 0.7);
            font-size: 1rem;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Smart Pot Monitor</h1>
    <div class="dashboard-container">
        <div class="metric-container">
            <h2>Temperature</h2>
            <div class="current-value"><span id="temperature">0</span> °C</div>
            <div id="temp-chart-container">
                <canvas id="temp-chart"></canvas>
            </div>
        </div>

        <div class="metric-container">
            <h2>Humidity</h2>
            <div class="current-value"><span id="humidity">0</span>%</div>
            <div id="humidity-gauge-container">
                <canvas id="humidity-gauge"></canvas>
            </div>
        </div>

        <div class="metric-container">
            <h2>Light Intensity</h2>
            <div class="current-value"><span id="light">0</span>%</div>
            <div id="light-meter-container">
                <div class="light-meter">
                    <div id="light-level" class="light-level"></div>
                </div>
            </div>
        </div>
    </div>
    <p id="status" class="status">Fetching data...</p>

    <script>
        let latestData = { temperature: 0, humidity: 0, light: 0 };

        const tempCtx = document.getElementById('temp-chart').getContext('2d');
        const temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Temperature (°C)',
                    data: [],
                    borderColor: 'rgb(14, 104, 4)',
                    backgroundColor: 'rgba(14, 104, 4, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'realtime',
                        realtime: {
                            duration: 60000,
                            refresh: 2000,
                            delay: 1000,
                            onRefresh: chart => {
                                if (latestData && typeof latestData.temperature !== 'undefined') {
                                    chart.data.datasets[0].data.push({
                                        x: Date.now(),
                                        y: latestData.temperature
                                    });
                                }
                            }
                        },
                        ticks: { color: 'rgb(14, 104, 4)', maxRotation: 0, autoSkip: true, maxTicksLimit: 5 },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: 'rgb(14, 104, 4)' },
                        grid: { color: 'rgba(14, 104, 4, 0.2)' }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom', // Changed position
                        labels: { color: 'rgb(14, 104, 4)' }
                    }
                }
            }
        });

        const humidityCtx = document.getElementById('humidity-gauge').getContext('2d');
        const humidityGauge = new Chart(humidityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Humidity', 'Remaining'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#0E6804', '#E0E0E0'],
                    borderColor: ['#afe9b3', '#afe9b3'],
                    borderWidth: 2,
                    circumference: 180,
                    rotation: 270,
                    cutout: '40%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });

        function getHumiditySectorColor(humidity) {
            if (humidity < 30) return '#FF6384';
            if (humidity < 70) return '#FFCE56'; 
            return '#4BC0C0';
        }

        const lightLevelIndicator = document.getElementById('light-level');
        function updateLightMeter(lightPercentage) {
            const percentage = Math.max(0, Math.min(100, lightPercentage));
            lightLevelIndicator.style.width = percentage + '%';
            if (percentage >= 99) {
                lightLevelIndicator.style.borderRadius = '15px';
            } else {
                lightLevelIndicator.style.borderRadius = '15px 0 0 15px';
            }
        }

        async function fetchDataAndUpdate() {
            try {
                const response = await fetch('/update');
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                latestData = data;

                document.getElementById('temperature').textContent = data.temperature !== undefined ? data.temperature.toFixed(1) : 'N/A';

                const humidityValue = data.humidity !== undefined ? parseFloat(data.humidity) : 0;
                document.getElementById('humidity').textContent = humidityValue.toFixed(0);
                humidityGauge.data.datasets[0].data[0] = humidityValue;
                humidityGauge.data.datasets[0].data[1] = Math.max(0, 100 - humidityValue);
                humidityGauge.data.datasets[0].backgroundColor[0] = getHumiditySectorColor(humidityValue);
                humidityGauge.update('none');

                const lightValue = data.light !== undefined ? parseFloat(data.light) : 0;
                document.getElementById('light').textContent = lightValue.toFixed(0);
                updateLightMeter(lightValue);

                document.getElementById('status').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                document.getElementById('status').style.color = 'rgb(14, 104, 4)';

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('status').textContent = `Error: ${error.message}. Retrying...`;
                document.getElementById('status').style.color = 'red';
            }
        }

        fetchDataAndUpdate();
        setInterval(fetchDataAndUpdate, 2000);
    </script>
</body>
</html>
